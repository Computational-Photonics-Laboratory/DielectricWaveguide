function[Ez]=WG2D_GetEz_f(x,y,Ex,Ey,eps,neff,lambda)

Nx=length(x);
Ny=length(y);
Nxy=Nx*Ny;

dx=x(2)-x(1);
dy=y(2)-y(1);

k0=2*pi/lambda;
Beta=neff^2*k0^2;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% Building of the operators %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

AA=ones(1,Nx*Ny);
BB=ones(1,Nx*Ny-1);
BB(Ny:Ny:end)=0;

DY1=diag(BB,-1)*(-0.5) + diag(BB,1)*(0.5);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Axy=ones(1,(Nx-1)*Ny);
DX1 = (-0.5)*diag(Axy,-Ny) + (+0.5)*diag(Axy,Ny);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Ez = (1/i.Beta.eps) * (d(eps.Ex)/dx + d(eps.Ey)/dy)  because div(D)=div(eps.E)=0

Ez = (1./(1i*eps(:)*Beta)) .* ( DX1/dx*(eps(:).*Ex(:)) + DY1/dy*(eps(:).*Ey(:)) ) ;

Ez=reshape(Ez,[Ny,Nx]);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%% First derivative X %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DX1(Ny=5,Nx=4); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                  %
%   0   0   0   0   0 |1/2  0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0  1/2  0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0  1/2  0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0  1/2  0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0  1/2| 0   0   0   0   0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
% -1/2  0   0   0   0 | 0   0   0   0   0 |1/2  0   0   0   0 | 0   0   0   0   0  %
%   0 -1/2  0   0   0 | 0   0   0   0   0 | 0  1/2  0   0   0 | 0   0   0   0   0  %
%   0   0 -1/2  0   0 | 0   0   0   0   0 | 0   0  1/2  0   0 | 0   0   0   0   0  %
%   0   0   0 -1/2  0 | 0   0   0   0   0 | 0   0   0  1/2  0 | 0   0   0   0   0  %
%   0   0   0   0 -1/2| 0   0   0   0   0 | 0   0   0   0  1/2| 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 -1/2  0   0   0   0 | 0   0   0   0   0 |1/2  0   0   0   0  %
%   0   0   0   0   0 | 0 -1/2  0   0   0 | 0   0   0   0   0 | 0  1/2  0   0   0  %
%   0   0   0   0   0 | 0   0 -1/2  0   0 | 0   0   0   0   0 | 0   0  1/2  0   0  %
%   0   0   0   0   0 | 0   0   0 -1/2  0 | 0   0   0   0   0 | 0   0   0  1/2  0  %
%   0   0   0   0   0 | 0   0   0   0 -1/2| 0   0   0   0   0 | 0   0   0   0  1/2 %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0   0   0   0   0 -1/2  0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0 -1/2  0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0 -1/2  0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0 -1/2  0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0 -1/2| 0   0   0   0   0  %
%                                                                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%% First derivative Y %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DY1(Ny=5,Nx=4); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                  %
%   0  1/2  0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
% -1/2  0  1/2  0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0 -1/2  0  1/2  0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0 -1/2  0  1/2| 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0 -1/2  0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0  1/2  0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 -1/2  0  1/2  0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0 -1/2  0  1/2  0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0 -1/2  0  1/2| 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0 -1/2  0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0  1/2  0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 -1/2  0  1/2  0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0 -1/2  0  1/2  0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0 -1/2  0  1/2| 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0 -1/2  0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0  1/2  0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 -1/2  0  1/2  0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0 -1/2  0  1/2  0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0 -1/2  0  1/2 %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0 -1/2  0  %
%                                                                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
