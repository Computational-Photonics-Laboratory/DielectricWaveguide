function[Hx,Hy,Hz]=WG2D_GetHxHyHz_f(x,y,Ex,Ey,eps,neff,lambda)

Nx=length(x);
Ny=length(y);
Nxy=Nx*Ny;

dx=x(2)-x(1);
dy=y(2)-y(1);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

c=2.99792458e8;       %% m/s
eps0=8.85418782e-12;  %% F/m
mu0 = 4*pi*1e-7;      %% H/m

k0=2*pi/lambda;
w=c*k0;
Beta=neff^2*k0^2;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% Building of the operators %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

AA=ones(1,Nx*Ny);
BB=ones(1,Nx*Ny-1);
BB(Ny:Ny:end)=0;

DY1=diag(BB,-1)*(-0.5) + diag(BB,1)*(0.5);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Axy=ones(1,(Nx-1)*Ny);

DX1 =     (-0.5)*diag(Axy,-Ny) + (+0.5)*diag(Axy,Ny);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Ez = (1/i.Beta.eps) * (d(eps.Ex)/dx + d(eps.Ey)/dy)  because div(D)=div(eps.E)=0

Ez = (1./(1i*eps(:)*Beta)) .* ( DX1/dx*(eps(:).*Ex(:)) + DY1/dy*(eps(:).*Ey(:)) ) ;

%Hx = -1/(i*w*mu0) * ( dEz/dy - dEy/dz );
%Hy = -1/(i*w*mu0) * ( dEx/dz - dEz/dx );
%Hz = -1/(i*w*mu0) * ( dEy/dx - dEx/dy );

Hx = -1/(1i*w*mu0) * ( +DY1/dy*Ez(:)  + 1i*Beta*Ey(:) );

Hy = -1/(1i*w*mu0) * ( -1i*Beta*Ex(:) - DX1/dx*Ez(:) );

Hz = -1/(1i*w*mu0) * ( + DX1/dx*Ey(:) - DY1/dy*Ex(:) );

%Ez=reshape(Ez,[Ny,Nx]);
Hx=reshape(Hx,[Ny,Nx]);
Hy=reshape(Hy,[Ny,Nx]);
Hz=reshape(Hz,[Ny,Nx]);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%% First derivative X %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DX1(Ny=5,Nx=4); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                  %
%   0   0   0   0   0 |1/2  0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0  1/2  0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0  1/2  0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0  1/2  0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0  1/2| 0   0   0   0   0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
% -1/2  0   0   0   0 | 0   0   0   0   0 |1/2  0   0   0   0 | 0   0   0   0   0  %
%   0 -1/2  0   0   0 | 0   0   0   0   0 | 0  1/2  0   0   0 | 0   0   0   0   0  %
%   0   0 -1/2  0   0 | 0   0   0   0   0 | 0   0  1/2  0   0 | 0   0   0   0   0  %
%   0   0   0 -1/2  0 | 0   0   0   0   0 | 0   0   0  1/2  0 | 0   0   0   0   0  %
%   0   0   0   0 -1/2| 0   0   0   0   0 | 0   0   0   0  1/2| 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 -1/2  0   0   0   0 | 0   0   0   0   0 |1/2  0   0   0   0  %
%   0   0   0   0   0 | 0 -1/2  0   0   0 | 0   0   0   0   0 | 0  1/2  0   0   0  %
%   0   0   0   0   0 | 0   0 -1/2  0   0 | 0   0   0   0   0 | 0   0  1/2  0   0  %
%   0   0   0   0   0 | 0   0   0 -1/2  0 | 0   0   0   0   0 | 0   0   0  1/2  0  %
%   0   0   0   0   0 | 0   0   0   0 -1/2| 0   0   0   0   0 | 0   0   0   0  1/2 %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0   0   0   0   0 -1/2  0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0 -1/2  0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0 -1/2  0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0 -1/2  0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0 -1/2| 0   0   0   0   0  %
%                                                                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%% First derivative Y %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DY1(Ny=5,Nx=4); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                  %
%   0  1/2  0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
% -1/2  0  1/2  0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0 -1/2  0  1/2  0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0 -1/2  0  1/2| 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0 -1/2  0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0  1/2  0   0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 -1/2  0  1/2  0   0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0 -1/2  0  1/2  0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0 -1/2  0  1/2| 0   0   0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0 -1/2  0 | 0   0   0   0   0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0  1/2  0   0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 -1/2  0  1/2  0   0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0 -1/2  0  1/2  0 | 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0 -1/2  0  1/2| 0   0   0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0 -1/2  0 | 0   0   0   0   0  %
%   -----------------------------------------------------------------------------  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0  1/2  0   0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 -1/2  0  1/2  0   0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0 -1/2  0  1/2  0  %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0 -1/2  0  1/2 %
%   0   0   0   0   0 | 0   0   0   0   0 | 0   0   0   0   0 | 0   0   0 -1/2  0  %
%                                                                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
